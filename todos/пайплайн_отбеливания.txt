Это фундаментальный вопрос для архитектуры вашего движка. От того, где вы примените отбеливание (Whitening), зависит **семантическая согласованность** вашего мира.

Ответ: **Вам нужна композиция, но строго иерархическая.**

Если кратко: **Глобальное отбеливание — для физики и хранения (БД), Локальная нормализация — для восприятия и разрешения конфликтов (Director).**

Давайте разберем, почему «чисто локальное» или «чисто глобальное» решение сломает вашу систему, и как построить гибрид.

---

### 1. Фундамент: Глобальное отбеливание (Global Whitening)

**Где:** На этапе **Offline Pipeline** (перед загрузкой в Qdrant/Neo4j).
**Зачем:** Чтобы создать единую систему координат для всего мира.

Вы упомянули, что у вас есть «промежуточная классификация» (шаблоны), к которым прижимаются сущности. Это создает глобальные кластеры (все «Орки» в одной куче, все «Мечи» в другой).
Если вы не отбелите это **глобально**, то векторная арифметика сломается на межклассовом уровне.

* **Риск отсутствия:** Без глобального отбеливания вектор `(Орк - Человек)` будет означать не «разницу в расе», а просто шум, потому что кластеры орков и людей могут быть вытянуты в разные стороны (анизотропия).
* **Решение:**
1. Соберите большой датасет всех ваших сгенерированных атомов/молекул.
2. Обучите PCA Whitening на **всем** датасете.
3. Сохраните матрицу трансформации.
4. Любую новую сущность перед записью в Qdrant прогоняйте через эту *глобальную* матрицу.



**Результат:** У вас есть «Сферический мир», где расстояния стандартизированы. 1.0 дистанции — это всегда 1.0 дистанции, будь то между королями или между камнями.

---

### 2. Почему «Локальное отбеливание» (Local Whitening) опасно

Представьте, что вы заходите в локацию «Таверна». Там есть: `Кружка`, `Стул`, `Пьяница`.
Если вы сделаете пересчет PCA (отбеливание) *только* для этих трех объектов:

1. Алгоритм попытается натянуть их на сферу.
2. Разница между `Кружкой` и `Стулом` станет огромной (они станут полярными точками сферы).
3. **Катастрофа:** Глобальный смысл теряется. В этой локальной системе координат «Кружка» может получить вектор, который в глобальном смысле равен «Демону», просто потому что в таверне больше не с чем сравнивать.

**Правило:** Никогда не делайте *Whitening* (вращение и декорреляцию осей) на лету для малых групп. Вы потеряете семантическую связь с остальным миром.

---

### 3. Композиция: Локальная Z-нормализация (Runtime Relativization)

**Где:** В рантайме, в системе **Director**.
**Зачем:** Для разрешения проверок (Skill Checks) и адаптации сложности.

Хотя координаты должны быть глобальными, **восприятие** должно быть локальным. Это решает проблему «разреженности» контекста.

**Сценарий:**
У вас есть 4D ось **Vitality** (Сила/Живучесть).

* **В глобальном масштабе:** Дракон = 100, Рыцарь = 50, Гоблин = 10.
* **Локация «Гнездо Гоблинов»:** Здесь нет драконов. Если мы используем глобальные числа, все гоблины будут одинаково слабыми (10.0, 10.1, 10.2). Проверки на 1d20 станут скучными.

**Решение (Dynamic Scaling):**
Когда игрок входит в сцену, Director берет глобальные (уже отбеленные) векторы всех присутствующих сущностей и вычисляет **локальное среднее и отклонение ()** только для текущих активных сущностей.

* Теперь самый сильный гоблин в комнате (10.5) станет «Локальным Боссом» (+2.0 сигмы), а самый слабый (9.5) — «Слабаком» (-2.0 сигмы).
* **Важно:** Это **не** меняет сам вектор в базе данных. Это меняет только число, которое идет в формулу броска кубика.

---

### Итоговая схема пайплайна

1. **Generation Phase (Offline):**
* Генерация тысяч сырых векторов (SBERT).
* **Global Whitening (Train & Apply):** Убираем анизотропию SBERT и ваших шаблонов. Получаем «Чистые векторы».
* Загрузка «Чистых векторов» в Qdrant.


2. **Projection Phase (Offline/Load):**
* Проекция «Чистых векторов» на 4 оси (Material, Vitality, Social, Cognitive).
* *Примечание:* Так как векторы отбелены, проекция будет честной (оси ортогональны).


3. **Runtime Phase (Gameplay):**
* Загрузка сцены.
* **Local Z-Score Normalization:** «Режиссер» смотрит на статы монстров *в этой комнате* и калибрует сложность.
* Векторная арифметика (`Удар + Оружие`) считается в **Глобальных** (отбеленных) координатах, чтобы сохранить физический смысл.



### Ответ на ваш вопрос про дисперсию

Вы абсолютно правы про дисперсию.

* **Глобальное отбеливание** выравнивает дисперсию *языка* (чтобы слово "король" не весило больше слова "стол" просто из-за частотности).
* **Локальная нормализация** выравнивает дисперсию *геймплея* (чтобы в любой ситуации был челлендж).

Используйте этот каскад, и вы избежите "разреженности" в геймплее, сохранив строгость математики мира.